<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <title>POS Khmer (Editable + QR + Save PNG)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    @media print { #receipt { display:none; } }
  </style>
</head>
<body class="bg-gray-100 p-4">

<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow">

  <h1 class="text-3xl font-bold text-center mb-6">ប្រព័ន្ធលក់ (POS)</h1>

  <!-- Customer Name -->
  <div class="mb-4">
    <input id="customer" placeholder="ឈ្មោះអតិថិជន" class="border p-2 rounded w-full">
  </div>

  <!-- Input Product -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
    <input id="name" placeholder="ឈ្មោះទំនិញ" class="border p-2 rounded">
    <input id="price" type="number" placeholder="តម្លៃ (៛)" class="border p-2 rounded">
    <input id="qty" type="number" placeholder="ចំនួន" class="border p-2 rounded">
    <button onclick="addProduct()" class="bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700">បន្ថែម</button>
  </div>

  <!-- Search -->
  <div class="flex gap-2 mb-4">
    <input id="search" placeholder="ស្វែងរកឈ្មោះទំនិញ" class="border p-2 rounded w-full">
    <button onclick="searchProduct()" class="bg-blue-600 text-white px-4 rounded">ស្វែងរក</button>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">ឈ្មោះ</th>
          <th class="border p-2">តម្លៃ</th>
          <th class="border p-2">ចំនួន</th>
          <th class="border p-2">សរុប</th>
          <th class="border p-2">លុប</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Total -->
  <div class="text-right mt-4">
    <h2 id="grandTotal" class="text-2xl font-bold">តម្លៃសរុប: 0 ៛</h2>
  </div>

  <!-- Show Receipt -->
  <button onclick="showReceipt()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">បង្ហាញវិក័យប័ត្រ</button>
</div>

<!-- Receipt -->
<div id="receipt" class="hidden max-w-md mx-auto bg-white mt-6 p-6 shadow rounded">
  <h2 class="text-center text-xl font-bold">វិក័យប័ត្រ</h2>
  <p class="text-center text-sm mb-2" id="receiptDate"></p>
  <p class="text-center text-sm mb-2">អតិថិជន: <span id="receiptCustomer"></span></p>

  <hr class="my-2 border-dashed">

  <table class="w-full text-sm">
    <thead>
      <tr>
        <th class="text-left">ទំនិញ</th>
        <th class="text-center">ចំនួន</th>
        <th class="text-right">សរុប</th>
      </tr>
    </thead>
    <tbody id="receiptBody"></tbody>
  </table>

  <hr class="my-2 border-dashed">

  <div class="text-right font-bold text-lg">
    តម្លៃសរុប: <span id="receiptTotal">0 ៛</span>
  </div>

  <div class="flex justify-center mt-4">
    <canvas id="bakongQR"></canvas>
  </div>

  <p class="text-center text-xs mt-4">សូមអរគុណសម្រាប់ការទិញ!</p>

  <div class="flex gap-2 mt-4">
    <button onclick="downloadReceipt()" class="w-full bg-green-600 text-white py-2 rounded">ទាញយកជា PNG</button>
    <button onclick="hideReceipt()" class="w-full bg-gray-400 text-white py-2 rounded">បិទ</button>
  </div>
</div>

<script>
let cart = [];
let grandTotal = 0;

/* Add Product */
function addProduct() {
  const name = document.getElementById("name").value.trim();
  const price = Number(document.getElementById("price").value);
  const qty = Number(document.getElementById("qty").value);
  if(!name || price<=0 || qty<=0){ alert("សូមបញ្ចូលព័ត៌មានត្រឹមត្រូវ"); return; }
  const total = price*qty;
  grandTotal += total;
  cart.push({name, price, qty, total});
  renderTable();
  updateTotal();
  clearInput();
}

/* Render Table with editable inputs */
function renderTable(){
  const body = document.getElementById("tableBody");
  body.innerHTML="";
  cart.forEach((item,index)=>{
    body.innerHTML += `
      <tr class="text-center">
        <td class="border p-2">${item.name}</td>
        <td class="border p-2">
          <input type="number" value="${item.price}" class="w-20 text-center border rounded" onchange="updateItem(${index},'price',this.value)">
        </td>
        <td class="border p-2">
          <input type="number" value="${item.qty}" class="w-16 text-center border rounded" onchange="updateItem(${index},'qty',this.value)">
        </td>
        <td class="border p-2">${item.total.toLocaleString()} ៛</td>
        <td class="border p-2">
          <button onclick="deleteItem(${index})" class="bg-red-600 text-white px-2 rounded">លុប</button>
        </td>
      </tr>
    `;
  });
}

/* Update item inline */
function updateItem(index,field,value){
  value = Number(value);
  if(isNaN(value)||value<=0) return;
  grandTotal -= cart[index].total;
  if(field==='price') cart[index].price=value;
  if(field==='qty') cart[index].qty=value;
  cart[index].total = cart[index].price*cart[index].qty;
  grandTotal += cart[index].total;
  renderTable();
  updateTotal();
}

/* Delete item */
function deleteItem(index){
  grandTotal -= cart[index].total;
  cart.splice(index,1);
  renderTable();
  updateTotal();
}

/* Search */
function searchProduct(){
  const keyword = document.getElementById("search").value.toLowerCase();
  renderTable();
  if(!keyword) return;
  const body=document.getElementById("tableBody");
  body.innerHTML="";
  cart.filter(p=>p.name.toLowerCase().includes(keyword))
      .forEach((item,index)=>{
        body.innerHTML += `
          <tr class="text-center">
            <td class="border p-2">${item.name}</td>
            <td class="border p-2">
              <input type="number" value="${item.price}" class="w-20 text-center border rounded" onchange="updateItem(${index},'price',this.value)">
            </td>
            <td class="border p-2">
              <input type="number" value="${item.qty}" class="w-16 text-center border rounded" onchange="updateItem(${index},'qty',this.value)">
            </td>
            <td class="border p-2">${item.total.toLocaleString()} ៛</td>
            <td class="border p-2">
              <button onclick="deleteItem(${index})" class="bg-red-600 text-white px-2 rounded">លុប</button>
            </td>
          </tr>
        `;
      });
}

/* Update total */
function updateTotal(){ document.getElementById("grandTotal").innerText=`តម្លៃសរុប: ${grandTotal.toLocaleString()} ៛`;}

/* Clear input */
function clearInput(){ document.getElementById("name").value=""; document.getElementById("price").value=""; document.getElementById("qty").value=""; }

/* Show Receipt */
function showReceipt(){
  if(cart.length===0){ alert("មិនទាន់មានទំនិញទេ"); return; }
  const customer = document.getElementById("customer").value.trim() || "មិនមានឈ្មោះ";
  document.getElementById("receipt").classList.remove("hidden");
  document.getElementById("receiptDate").innerText = new Date().toLocaleString();
  document.getElementById("receiptCustomer").innerText = customer;

  const body = document.getElementById("receiptBody");
  body.innerHTML="";
  cart.forEach(item=>{
    body.innerHTML += `<tr>
      <td>${item.name}</td>
      <td class="text-center">${item.qty}</td>
      <td class="text-right">${item.total.toLocaleString()} ៛</td>
    </tr>`;
  });
  document.getElementById("receiptTotal").innerText = grandTotal.toLocaleString() + " ៛";

  // Generate QR
  const qrText=`អតិថិជន: ${customer}\nសរុប: ${grandTotal.toLocaleString()} ៛`;
  QRCode.toCanvas(document.getElementById("bakongQR"), qrText, {width:150});
}

/* Hide receipt */
function hideReceipt(){ document.getElementById("receipt").classList.add("hidden"); }

/* Download receipt as PNG */
function downloadReceipt(){
  html2canvas(document.getElementById("receipt")).then(canvas=>{
    const link=document.createElement("a");
    link.download="receipt.png";
    link.href=canvas.toDataURL("image/png");
    link.click();
  });
}
</script>

</body>
</html>
